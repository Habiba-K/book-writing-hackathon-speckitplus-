# Data Model: RAG Agent with Groq API

**Feature**: 001-rag-agent
**Date**: 2025-12-19

## Core Entities

### Query
**Description**: User's natural language question or request for information
**Fields**:
- text: string - The actual query text from the user
- timestamp: datetime - When the query was received
- metadata: object - Additional context (optional)

### AgentResponse
**Description**: The response generated by the RAG agent
**Fields**:
- answer: string - The contextual answer generated by the agent
- primary_source: Source - The single primary source to be displayed as clickable in the main response
- sources: array of Source - List of all sources used to generate the answer (for JSON response only)
- matched_chunks: array of Chunk - Content chunks retrieved from Qdrant
- query_time: float - Time taken to process the request (in seconds)
- success: boolean - Whether the operation was successful
- is_out_of_scope: boolean - Whether the query was out of the book's scope (if true, answer contains out-of-scope message)

### Source
**Description**: Reference to the original document or location of retrieved information
**Fields**:
- url: string - URL or identifier of the source document
- title: string - Title of the source document
- chunk_index: integer - Index position of the chunk within the source

### Chunk
**Description**: Content chunk retrieved from Qdrant that matches the query semantically
**Fields**:
- text: string - The actual text content of the chunk
- similarity_score: float - How closely this chunk matches the query (0.0-1.0)
- source: Source - Reference to the original source document
- metadata: object - Additional metadata associated with the chunk

## Relationships

- AgentResponse contains one primary_source (for display)
- AgentResponse contains many Source objects (via sources field, for JSON response)
- AgentResponse contains many Chunk objects (via matched_chunks field)
- Chunk is associated with one Source (via source field)
- Query generates one AgentResponse

## Validation Rules

### Query Validation
- text must not be empty or contain only whitespace
- text length must be within reasonable limits (e.g., max 2000 characters)

### AgentResponse Validation
- answer must be provided when success is true
- sources and matched_chunks must be provided when success is true
- query_time must be a positive number
- success must be a boolean value
- When is_out_of_scope is true, answer should contain "sorry this content is not related to this book"
- primary_source must be provided when success is true and query is in scope

### Source Validation
- url must be a valid URL format
- title must not be empty
- chunk_index must be a non-negative integer

### Chunk Validation
- text must not be empty
- similarity_score must be between 0.0 and 1.0
- source must be a valid Source object

## State Transitions

### Query Processing States
1. **Received**: Query has been received by the agent
2. **Scope Check**: Agent determines if query is within book scope
3. **Processing**: Agent is retrieving relevant information from Qdrant (if in scope)
4. **Answering**: Agent is generating the answer based on retrieved information (if in scope) or out-of-scope message
5. **Completed**: Agent has generated a complete response
6. **Failed**: Agent encountered an error during processing

## Data Flow

1. User submits a Query to the agent
2. Agent checks if the Query is within the book's scope
3. If out of scope: Agent creates an AgentResponse with is_out_of_scope=true and answer="sorry this content is not related to this book"
4. If in scope: Agent processes the Query and retrieves relevant Chunks from Qdrant using the retrieve function
5. Agent selects one primary_source for clickable display
6. Agent generates an answer based on the retrieved Chunks
7. Agent creates an AgentResponse containing the answer, primary_source, sources, and matched chunks
8. AgentResponse is returned to the user with primary_source formatted as "Source: Document X: [Title] ([URL])"